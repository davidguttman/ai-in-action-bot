<!-- Generated by SpecStory -->

# MongoDB Connection and Speaker Model Tutorial (2025-04-18 13:37:41)

_**User**_

Create a new markdown file in the tutorials directory. USE ls/tree to see the files in the codebase, and then write a detailed step-by-step tutorial that shows how to do the following

Setup MongoDB Connection and Speaker Model

**Goal:** Establish MongoDB connection handling and define the data structure for scheduled speakers.

**Prompt:**

```text
Big D, update the MongoDB integration and define the data model for speaker scheduling.

1.  **Modify `lib/mongo/mongo.js`:**
    *   Ensure it exports functions `connectDB` and `disconnectDB`.
    *   The `connectDB` function should use the `MONGODB_URI` environment variable.
    *   Implement basic connection event listeners (connected, error, disconnected) that log messages.
2.  **Modify `lib/mongo/index.js`:**
    *   Require `mongoose`.
    *   Require `./mongo.js`.
    *   Export `connectDB`, `disconnectDB` from `./mongo.js`.
    *   Export `mongoose`.
3.  **Rename `models/widget.js` to `models/scheduledSpeaker.js`**.
4.  **Update `models/scheduledSpeaker.js`:**
    *   Require `mongoose` from `../lib/mongo`.
    *   Define a Mongoose schema named `scheduledSpeakerSchema` according to the specification:
        *   `discordUserId`: String, required
        *   `discordUsername`: String, required
        *   `topic`: String, required
        *   `scheduledDate`: Date, required
        *   `bookingTimestamp`: Date, default: `Date.now`
        *   `threadId`: String (optional)
    *   Add a unique index on the `scheduledDate` field. Set `unique: true` in the schema definition for `scheduledDate`.
    *   Ensure the `scheduledDate` specifically stores only the Date part (or handle comparisons carefully later). Consider using `set: v => v.setHours(0, 0, 0, 0)` in the schema type options if needed, though indexing might work correctly on the Date object directly in MongoDB.
    *   Create and export the Mongoose model: `mongoose.model('ScheduledSpeaker', scheduledSpeakerSchema)`.
5.  **Update `index.js` or `server.js` (main entry point):**
    *   Require `connectDB` from `./lib/mongo`.
    *   Call `connectDB()` near the start of the application initialization.
```



Finally, use ls and check if file has been created

---

_**Assistant**_



---

Okay Big D, I can certainly create that tutorial for you. First, I need to get a sense of the current file structure to know where the `tutorials` directory should be or if it exists already.



---

```bash
tree -I node_modules
```

```
.
â”œâ”€â”€ README.md
â”œâ”€â”€ api
â”‚Â Â  â”œâ”€â”€ auth-test.js
â”‚Â Â  â””â”€â”€ widgets.js
â”œâ”€â”€ config
â”‚Â Â  â””â”€â”€ index.js
â”œâ”€â”€ docs
â”‚Â Â  â”œâ”€â”€ plans
â”‚Â Â  â”‚Â Â  â””â”€â”€ 01-initial.md
â”‚Â Â  â”œâ”€â”€ specs
â”‚Â Â  â”‚Â Â  â””â”€â”€ 01-initial.md
â”‚Â Â  â””â”€â”€ tutorials
â”œâ”€â”€ index.js
â”œâ”€â”€ lib
â”‚Â Â  â”œâ”€â”€ auto-catch.js
â”‚Â Â  â”œâ”€â”€ discord
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ commands
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ check.js
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ llm.js
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ deploy-commands.js
â”‚Â Â  â”‚Â Â  â””â”€â”€ index.js
â”‚Â Â  â”œâ”€â”€ llm
â”‚Â Â  â”‚Â Â  â””â”€â”€ index.js
â”‚Â Â  â””â”€â”€ mongo
â”‚Â Â      â”œâ”€â”€ index.js
â”‚Â Â      â”œâ”€â”€ mock-mongo.js
â”‚Â Â      â””â”€â”€ mongo.js
â”œâ”€â”€ middleware
â”‚Â Â  â”œâ”€â”€ auth-test.js
â”‚Â Â  â”œâ”€â”€ auth.js
â”‚Â Â  â””â”€â”€ index.js
â”œâ”€â”€ models
â”‚Â Â  â””â”€â”€ widget.js
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ server.js
â””â”€â”€ test
    â”œâ”€â”€ api
    â”‚Â Â  â”œâ”€â”€ health.test.js
    â”‚Â Â  â””â”€â”€ widgets.test.js
    â”œâ”€â”€ auth.test.js
    â”œâ”€â”€ auto-catch.test.js
    â”œâ”€â”€ helpers
    â”‚Â Â  â”œâ”€â”€ cleanup.js
    â”‚Â Â  â””â”€â”€ mock-auth.js
    â”œâ”€â”€ index.js
    â””â”€â”€ mongo.test.js

16 directories, 31 files


~/play/test/ai-in-action-bot main*

```

---

Okay Big D, I see the `docs/tutorials` directory exists. I will now create the tutorial file `docs/tutorials/01-mongodb-setup.md` with the detailed steps based on the plan you provided.



---

```diff
- 
+ # Tutorial: Setting up MongoDB Connection and Speaker Model
+ 
+ This tutorial guides you through establishing the MongoDB connection for the Stream Speaker Scheduling Bot and defining the data model (`ScheduledSpeaker`) used to store information about speakers and their scheduled times.
+ 
+ **Goal:** Establish MongoDB connection handling and define the data structure for scheduled speakers.
+ 
+ **Prerequisites:**
+ 
+ *   Node.js environment setup.
+ *   `mongoose` package installed (`npm install mongoose`).
+ *   An environment variable `MONGODB_URI` containing your MongoDB connection string.
+ 
+ ---
+ 
+ ## Step 1: Modify Connection Logic (`lib/mongo/mongo.js`)
+ 
+ This file handles the direct interaction with the `mongoose` library for connecting and disconnecting.
+ 
+ 1.  Ensure the file `lib/mongo/mongo.js` exists.
+ 2.  Update its content to the following:
+ 
+ ```javascript
+ // lib/mongo/mongo.js
+ const mongoose = require('mongoose')
+ 
+ const { MONGODB_URI } = process.env
+ 
+ if (!MONGODB_URI) {
+   throw new Error('MONGODB_URI environment variable is not set.')
+ }
+ 
+ const connectDB = async () => {
+   try {
+     await mongoose.connect(MONGODB_URI)
+     console.log('MongoDB connected successfully.')
+   } catch (err) {
+     console.error('MongoDB connection error:', err.message)
+     // Exit process with failure
+     process.exit(1)
+   }
+ }
+ 
+ const disconnectDB = async () => {
+   try {
+     await mongoose.disconnect()
+     console.log('MongoDB disconnected.')
+   } catch (err) {
+     console.error('Error disconnecting MongoDB:', err.message)
+   }
+ }
+ 
+ // Connection Events
+ mongoose.connection.on('connected', () => {
+   console.log('Mongoose connected to DB.')
+ })
+ 
+ mongoose.connection.on('error', (err) => {
+   console.error('Mongoose connection error:', err.message)
+ })
+ 
+ mongoose.connection.on('disconnected', () => {
+   console.log('Mongoose disconnected.')
+ })
+ 
+ module.exports = {
+   connectDB,
+   disconnectDB
+ }
+ ```
+ 
+ *   This code defines `connectDB` to establish the connection using the `MONGODB_URI`.
+ *   It includes basic event listeners to log connection status changes.
+ *   `disconnectDB` is provided for graceful shutdowns if needed later.
+ 
+ ---
+ 
+ ## Step 2: Update MongoDB Index (`lib/mongo/index.js`)
+ 
+ This file acts as a central point for accessing MongoDB-related functionalities, including the connection functions and the `mongoose` object itself.
+ 
+ 1.  Ensure the file `lib/mongo/index.js` exists.
+ 2.  Update its content:
+ 
+ ```javascript
+ // lib/mongo/index.js
+ const mongoose = require('mongoose')
+ const { connectDB, disconnectDB } = require('./mongo.js')
+ 
+ module.exports = {
+   mongoose,
+   connectDB,
+   disconnectDB
+ }
+ 
+ ```
+ 
+ *   This simply requires `mongoose` and the functions from `./mongo.js` and exports them for easy use elsewhere in the application.
+ 
+ ---
+ 
+ ## Step 3: Rename Model File
+ 
+ The project might have a placeholder model file. We need to rename it to represent our speaker data.
+ 
+ 1.  Locate the file `models/widget.js`.
+ 2.  Rename it to `models/scheduledSpeaker.js`. You can use your file explorer or the command line:
+     ```bash
+     mv models/widget.js models/scheduledSpeaker.js
+     ```
+ 
+ ---
+ 
+ ## Step 4: Define the Speaker Schema (`models/scheduledSpeaker.js`)
+ 
+ This file defines the structure (schema) of the documents that will be stored in the `scheduledSpeakers` collection in MongoDB.
+ 
+ 1.  Open the newly renamed `models/scheduledSpeaker.js`.
+ 2.  Update its content:
+ 
+ ```javascript
+ // models/scheduledSpeaker.js
+ const { mongoose } = require('../lib/mongo') // Use the exported mongoose instance
+ 
+ const scheduledSpeakerSchema = new mongoose.Schema({
+   discordUserId: {
+     type: String,
+     required: true
+   },
+   discordUsername: {
+     type: String,
+     required: true
+   },
+   topic: {
+     type: String,
+     required: true
+   },
+   scheduledDate: {
+     type: Date,
+     required: true,
+     unique: true, // Ensure only one speaker per date
+     // Optional: Normalize date to midnight UTC to simplify date-only comparisons
+     // set: (v) => {
+     //   if (v instanceof Date) {
+     //     return new Date(Date.UTC(v.getFullYear(), v.getMonth(), v.getDate()));
+     //   }
+     //   return v;
+     // }
+   },
+   bookingTimestamp: {
+     type: Date,
+     default: Date.now // Automatically set when a document is created
+   },
+   threadId: {
+     type: String // Optional: Store the Discord thread ID for context
+   }
+ })
+ 
+ // Optional: Add index explicitly if not relying solely on `unique: true`
+ // scheduledSpeakerSchema.index({ scheduledDate: 1 }, { unique: true });
+ 
+ const ScheduledSpeaker = mongoose.model('ScheduledSpeaker', scheduledSpeakerSchema)
+ 
+ module.exports = ScheduledSpeaker
+ ```
+ 
+ *   We import `mongoose` from our central `lib/mongo/index.js`.
+ *   The schema defines fields like `discordUserId`, `discordUsername`, `topic`, and `scheduledDate` as required.
+ *   `scheduledDate` is marked as `unique` to prevent double booking. A commented-out `set` function shows one way to normalize the date to midnight UTC if needed, though careful querying might suffice.
+ *   `bookingTimestamp` defaults to the current time.
+ *   `threadId` is optional.
+ *   Finally, we create and export the Mongoose model named `ScheduledSpeaker`. Mongoose will automatically use the plural, lowercased version (`scheduledspeakers`) as the collection name.
+ 
+ ---
+ 
+ ## Step 5: Initialize Connection in Entry Point (e.g., `index.js` or `server.js`)
+ 
+ The database connection needs to be established when the application starts.
+ 
+ 1.  Identify your main application entry point file (commonly `index.js` or `server.js`). Let's assume it's `index.js`.
+ 2.  Require the `connectDB` function near the top of the file.
+ 3.  Call `connectDB()` early in the application's startup sequence, before you need database access (e.g., before starting the server or Discord bot).
+ 
+ ```javascript
+ // index.js (or server.js)
+ require('dotenv').config() // Ensure environment variables are loaded
+ 
+ const { connectDB } = require('./lib/mongo')
+ // ... other requires (discord bot, express app, etc.)
+ 
+ async function startApp () {
+   // Connect to Database FIRST
+   await connectDB()
+ 
+   // ... initialize Discord bot
+   // ... start web server (if any)
+ 
+   console.log('Application started successfully.')
+ }
+ 
+ startApp()
+ 
+ // Optional: Handle graceful shutdown
+ process.on('SIGINT', async () => {
+   console.log('SIGINT received. Shutting down...')
+   const { disconnectDB } = require('./lib/mongo') // Require here if not already available
+   await disconnectDB()
+   process.exit(0)
+ })
+ ```
+ 
+ *   This example uses an `async function` `startApp` to ensure the database connects before other parts of the application initialize.
+ *   It also shows an optional `SIGINT` handler for graceful shutdown, including disconnecting the database.
+ 
+ ---
+ 
+ **Conclusion:**
+ 
+ You have now successfully configured the MongoDB connection handling and defined the `ScheduledSpeaker` model. The application can connect to the database on startup, and you have a structure ready for storing speaker schedule information. 
```

---

Okay, Big D. I've created the file `docs/tutorials/01-mongodb-setup.md` with the detailed tutorial steps.

Now, I'll just check if the file exists in the `docs/tutorials` directory as requested.



---

<details>
            <summary>Listed directory docs/tutorials â€¢ **1** results</summary>
        
| Name |
|-------|
| ðŸ“„ `01-mongodb-setup.md` |

</details>

---

Confirmed, Big D! The file `docs/tutorials/01-mongodb-setup.md` has been created successfully.

---

_**User**_

Edit the tutorial so that you don't have any mongo/mongoose setup and you just create the model directly in the same way as @widget.js 

---

_**Assistant**_



---



---

