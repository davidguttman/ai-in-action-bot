<!-- Generated by SpecStory -->

# Discord Date Selection Confirmation (2025-04-18 14:20:31)

_**User**_

@05-discord-date-selection-confirm.md 

---

_**Assistant**_



---

Okay, Big D. It looks like there's an issue in `lib/discord/index.js` where the code isn't waiting for the `findAvailableFridays` function to finish before trying to format the dates. Let's fix that.

First, I need to read the relevant parts of the `lib/discord/index.js` file to confirm the location of the error and see the `formatDatesForDisplay` function.

---

Read file: lib/discord/index.js

---

Read file: lib/discord/index.js

---

Okay, Big D. The `formatDatesForDisplay` function looks correct and expects an array.

The problem is definitely in the `awaiting_topic` state handler where `findAvailableFridays()` is called. We need to add `await` there. I'll also add `await` where `findAvailableFridays` is called again in the conflict handling section (`awaiting_date_selection` state) and the associated error handling, as those will have the same issue.

---

```diff
  
          try {
-           const availableDates = findAvailableFridays()
+           const availableDates = await findAvailableFridays()
            console.log(`Found available dates:`, availableDates)
  
                  console.warn(`scheduleSpeaker returned falsy value for thread ${threadId}, expected either success or error.`);
                  await message.reply("Hmm, something unexpected happened while booking. Let's try finding new dates.");
-                 const newAvailableDates = findAvailableFridays();
+                 const newAvailableDates = await findAvailableFridays();
                  if (!newAvailableDates || newAvailableDates.length === 0) {
                     await message.reply("Sorry, I couldn't find any available slots right now. Please try signing up again later.");
                   const selectedDateString = selectedDateObject.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                   
-                  const newAvailableDates = findAvailableFridays();
+                  const newAvailableDates = await findAvailableFridays();
                   
                   if (!newAvailableDates || newAvailableDates.length === 0) {
```

---

Okay Big D, I've added the missing `await` keywords. This should fix the `TypeError` you were seeing.

---



---

