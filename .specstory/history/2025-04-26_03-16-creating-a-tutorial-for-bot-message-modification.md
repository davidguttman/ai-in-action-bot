<!-- Generated by SpecStory -->

# Creating a Tutorial for Bot Message Modification (2025-04-25 20:16:09)

_**User**_

Create a new markdown file in the tutorials directory. It should be in the same style as previous tutorials. USE ls/tree to see the files in the codebase, and then write a detailed step-by-step tutorial that shows how to change the bot's message listing to also include the talk topic

Finally, use ls and check if file has been created

---

_**Assistant**_



---

```bash
tree -I node_modules | cat
```

```
.
├── Dockerfile
├── PROJECT.md
├── README.md
├── api
│   └── auth-test.js
├── captain-definition
├── config
│   └── index.js
├── docs
│   ├── plans
│   │   └── 01-initial.md
│   ├── specs
│   │   └── 01-initial.md
│   └── tutorials
│       ├── 01-mongodb-setup.md
│       ├── 02-scheduling-logic.md
│       ├── 03-discord-intent.md
│       ├── 04-discord-collect-topic-propose-dates.md
│       ├── 05-discord-date-selection-confirm.md
│       ├── 06-discord-view-schedule.md
│       ├── 07-error-handling-refinement.md
│       └── 08-testing-setup-initial-tests.md
├── index.js
├── lib
│   ├── auto-catch.js
│   ├── discord
│   │   ├── commands
│   │   │   ├── check.js
│   │   │   └── llm.js
│   │   ├── deploy-commands.js
│   │   └── index.js
│   ├── llm
│   │   └── index.js
│   ├── mongo
│   │   ├── index.js
│   │   ├── mock-mongo.js
│   │   └── mongo.js
│   └── schedulingLogic.js
├── middleware
│   ├── auth-test.js
│   ├── auth.js
│   └── index.js
├── models
│   └── scheduledSpeaker.js
├── package-lock.json
├── package.json
├── server.js
└── test
    ├── api
    │   └── health.test.js
    ├── auth.test.js
    ├── auto-catch.test.js
    ├── helpers
    │   ├── cleanup.js
    │   └── mock-auth.js
    ├── index.js
    ├── mongo.test.js
    └── schedulingLogic.test.js

16 directories, 42 files


~/play/test/ai-in-action-bot main*

```

---

Okay Big D, I see the project structure and the existing tutorials in `docs/tutorials`. I'll use `08-testing-setup-initial-tests.md` as a style reference.

First, I need to read `PROJECT.md` and the reference tutorial `docs/tutorials/08-testing-setup-initial-tests.md`. Then I'll figure out the code changes needed and write the new tutorial.

---

Read file: docs/tutorials/08-testing-setup-initial-tests.md

---

Read file: PROJECT.md

---

Okay, `PROJECT.md` just points to `README.md`. Let's read that instead.

---

Read file: README.md

---

Alright Big D, I've reviewed the README and the example tutorial. Now I need to figure out where the message listing is generated in the code. Based on the project structure and README, the Discord interactions are likely handled in `lib/discord/`. The command to view the schedule seems like the place where listing happens. Let's check the commands in `lib/discord/commands/`. There's a `check.js` file which seems relevant.

---

Read file: lib/discord/commands/check.js

---

Ah, my mistake Big D. `check.js` is just a simple test command. I need to find the command that actually *displays* the schedule. Looking back at the `tree` output and the tutorials list, there isn't an obvious "list schedule" command file. However, tutorial `06-discord-view-schedule.md` implies this functionality exists.

Let's search the codebase for functions related to getting the schedule, like `getUpcomingSchedule` which was mentioned in the testing tutorial (`08-testing-setup-initial-tests.md`).

---

<details>
            <summary>Searched codebase "getUpcomingSchedule" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `lib/schedulingLogic.js` | L82-106 |
| `test/schedulingLogic.test.js` | L1-19 |
| `lib/schedulingLogic.js` | L106-112 |
| `test/schedulingLogic.test.js` | L124-151 |
| `test/schedulingLogic.test.js` | L151-176 |
| `docs/tutorials/02-scheduling-logic.md` | L116-156 |
| `docs/tutorials/08-testing-setup-initial-tests.md` | L212-239 |
| `test/schedulingLogic.test.js` | L117-124 |
| `lib/schedulingLogic.js` | L1-46 |
| `docs/tutorials/02-scheduling-logic.md` | L75-116 |
| `docs/tutorials/06-discord-view-schedule.md` | L56-95 |
| `docs/tutorials/06-discord-view-schedule.md` | L36-56 |
| `lib/discord/index.js` | L283-314 |
| `docs/tutorials/02-scheduling-logic.md` | L36-75 |
| `test/schedulingLogic.test.js` | L19-38 |
| `docs/tutorials/06-discord-view-schedule.md` | L95-123 |
| `docs/tutorials/06-discord-view-schedule.md` | L123-167 |
| `test/schedulingLogic.test.js` | L38-61 |
| `docs/tutorials/08-testing-setup-initial-tests.md` | L157-212 |
| `lib/discord/index.js` | L1-34 |
| `docs/tutorials/02-scheduling-logic.md` | L156-180 |
| `docs/tutorials/06-discord-view-schedule.md` | L1-36 |
| `docs/tutorials/08-testing-setup-initial-tests.md` | L41-93 |
| `lib/schedulingLogic.js` | L46-82 |
| `test/schedulingLogic.test.js` | L61-91 |

</details>

---

Okay Big D, the search results point strongly towards `lib/discord/index.js` within the `messageCreate` event handler, specifically the section handling the `view_schedule` intent. This is where `getUpcomingSchedule` is called and the reply message is formatted.

Now, let's read that specific file to confirm and see how the message is currently formatted.

---

Read file: lib/discord/index.js

---

Okay Big D, I've found the relevant section in `lib/discord/index.js` starting around line 283 within the `messageCreate` handler:

```javascript
      else if (detectedIntent === 'view_schedule') {
          console.log('View schedule intent detected.')
          try { // Inner try for getting schedule + replying
            const limit = 5;
            const upcomingSpeakers = await getUpcomingSchedule(limit);
            console.log(`Retrieved ${upcomingSpeakers.length} upcoming speakers.`);

            if (!upcomingSpeakers || upcomingSpeakers.length === 0) {
              try { // Wrap reply
                 await message.reply("There are currently no speakers scheduled.");
              } catch (replyError) { console.error('Failed to send no speakers reply:', replyError); }
            } else {
              // THIS is where we format the message
              const scheduleLines = upcomingSpeakers.map(speaker => {
                const formattedDate = speaker.scheduledDate.toLocaleDateString('en-US', {
                  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                const userDisplay = speaker.discordUsername;
                // Current format: "- [Date]: @[Username]"
                return `- ${formattedDate}: @${userDisplay}`;
              });

              const scheduleMessage = `**Upcoming Speakers (Next ${limit}):**\\n${scheduleLines.join('\\n')}`;
              try { // Wrap reply
                 await message.reply(scheduleMessage);
              } catch (replyError) { console.error('Failed to send schedule reply:', replyError); }
            }
          } catch (dbError) {
            console.error('Database error retrieving schedule:', dbError);
            try { // Wrap error reply
               await message.reply("Sorry, I couldn't retrieve the schedule due to a database error.");
            } catch (replyError) { console.error('Failed to send DB error schedule reply:', replyError); }
          }
      }
```

The change is simple: we just need to include `speaker.topic` in the string returned by the `map` function.

Now I can write the tutorial content. I'll create a new file `docs/tutorials/09-include-topic-in-schedule-view.md`.

---

```diff
- 
+ # Tutorial: Discord - Include Topic in Schedule View
+ 
+ This tutorial modifies the existing 'view_schedule' capability to include the speaker's topic alongside their name and date.
+ 
+ **Goal:** Enhance the schedule output so users can see not just who is speaking and when, but also *what* they are speaking about.
+ 
+ **Prerequisites:**
+ 
+ *   Completion of previous tutorials, especially Tutorial 6 (`06-discord-view-schedule.md`), which implemented the initial `view_schedule` intent handling in `lib/discord/index.js`.
+ *   The `ScheduledSpeaker` model (`models/scheduledSpeaker.js`) includes a `topic` field.
+ *   The `getUpcomingSchedule` function (`lib/schedulingLogic.js`) returns speaker objects that include the `topic` field.
+ 
+ ---
+ 
+ ## Step 1: Locate the Schedule Formatting Code
+ 
+ We need to find the part of the code that takes the list of upcoming speakers and turns it into a text message for Discord. Based on Tutorial 6, this is within the `messageCreate` event handler in `lib/discord/index.js`.
+ 
+ 1.  **Open `lib/discord/index.js`**.
+ 2.  **Find the `messageCreate` listener:** Look for `client.on(Events.MessageCreate, async (message) => { ... });`.
+ 3.  **Find the `view_schedule` intent block:** Inside the listener, locate the `else if (detectedIntent === 'view_schedule') { ... }` block. This block is triggered when the LLM determines the user wants to see the schedule.
+ 4.  **Find the message formatting logic:** Within the `view_schedule` block, after the `upcomingSpeakers = await getUpcomingSchedule(limit);` call, find the code that formats the response when speakers *are* found. It will look something like this:
+ 
+     ```javascript
+     // Inside the 'else' block after checking if upcomingSpeakers is empty
+     const scheduleLines = upcomingSpeakers.map(speaker => {
+       const formattedDate = speaker.scheduledDate.toLocaleDateString('en-US', {
+         weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
+       });
+       const userDisplay = speaker.discordUsername;
+       // This is the line we need to change:
+       return `- ${formattedDate}: @${userDisplay}`;
+     });
+ 
+     const scheduleMessage = `**Upcoming Speakers (Next ${limit}):**\n${scheduleLines.join('\n')}`;
+     await message.reply(scheduleMessage);
+     ```
+ 
+ ---
+ 
+ ## Step 2: Modify the Message Format
+ 
+ Now, we'll adjust the line that creates each entry in the schedule list to include the topic.
+ 
+ 1.  **Access the topic:** The `speaker` object obtained from `getUpcomingSchedule` should already contain the `topic` field (as saved during the sign-up process).
+ 2.  **Update the `return` statement:** Modify the `return` line inside the `.map()` function to include `speaker.topic`. We can format it nicely, perhaps putting the topic in quotes.
+ 
+     **Change this:**
+     ```javascript
+     return `- ${formattedDate}: @${userDisplay}`;
+     ```
+ 
+     **To this:**
+     ```javascript
+     return `- ${formattedDate}: @${userDisplay} - "${speaker.topic}"`; // Added topic here
+     ```
+ 
+ 3.  **The modified block:** The relevant part of the `view_schedule` logic should now look like this:
+ 
+     ```javascript
+     // Inside the 'else' block for when speakers are found
+     const scheduleLines = upcomingSpeakers.map(speaker => {
+       const formattedDate = speaker.scheduledDate.toLocaleDateString('en-US', {
+         weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
+       });
+       const userDisplay = speaker.discordUsername;
+       // Include the topic in the output string
+       return `- ${formattedDate}: @${userDisplay} - "${speaker.topic}"`;
+     });
+ 
+     const scheduleMessage = `**Upcoming Speakers (Next ${limit}):**\n${scheduleLines.join('\n')}`;
+     // The rest of the block (sending the reply, error handling) remains the same
+     try { // Wrap reply
+       await message.reply(scheduleMessage);
+     } catch (replyError) { console.error('Failed to send schedule reply:', replyError); }
+     ```
+ 
+ ---
+ 
+ ## Step 3: Test the Updated Schedule View
+ 
+ 1.  **Restart your bot** to load the changes in `lib/discord/index.js`.
+ 2.  **Ensure Data Exists:** Make sure you have some future-dated speaker entries in your database that include topics. If necessary, run through the sign-up flow (`@YourBotName sign up`) to create some test entries.
+ 3.  **Ask for Schedule:** Mention the bot in a main channel and ask to see the schedule (e.g., `@YourBotName show schedule`, `@YourBotName who is speaking?`).
+ 4.  **Verify Output:**
+     *   Confirm the bot replies with the upcoming schedule.
+     *   Check that each line now includes the speaker's topic in quotes after their username, matching the format: `- [Formatted Date]: @[Username] - "[Topic]"`.
+     *   Ensure the date and username are still displayed correctly.
+ 
+ ---
+ 
+ **Conclusion:**
+ 
+ You have successfully updated the schedule view command! Users now get more context by seeing the topic associated with each scheduled speaker, making the schedule information more complete and useful. This was a small change focused on improving the presentation of existing data. 
```

---

Excellent, Big D. The new tutorial file `docs/tutorials/09-include-topic-in-schedule-view.md` has been created.

Now, let's verify it's there.

---

```bash
ls docs/tutorials | cat
```

```
01-mongodb-setup.md
02-scheduling-logic.md
03-discord-intent.md
04-discord-collect-topic-propose-dates.md
05-discord-date-selection-confirm.md
06-discord-view-schedule.md
07-error-handling-refinement.md
08-testing-setup-initial-tests.md
09-include-topic-in-schedule-view.md


~/play/test/ai-in-action-bot main*

```

---

Confirmed, Big D. The file `09-include-topic-in-schedule-view.md` is present in the `docs/tutorials` directory.

Finally, I'll check `PROJECT.md`. Since it just points to the README and adding a tutorial doesn't fundamentally change the project structure or setup described there, no update is needed for `PROJECT.md`.

The task is complete. The new tutorial has been created in the requested style and location.

---

_**User**_

first ls/tree the codebase, then follow the tutorial to implement the changes to codebase 

---

_**Assistant**_



---

Okay Big D, let's implement that tutorial.

First, I'll view the codebase structure and read `PROJECT.md`.

---

Read file: PROJECT.md

---

```bash
tree -I node_modules | cat
```

```
.
├── Dockerfile
├── PROJECT.md
├── README.md
├── api
│   └── auth-test.js
├── captain-definition
├── config
│   └── index.js
├── docs
│   ├── plans
│   │   └── 01-initial.md
│   ├── specs
│   │   └── 01-initial.md
│   └── tutorials
│       ├── 01-mongodb-setup.md
│       ├── 02-scheduling-logic.md
│       ├── 03-discord-intent.md
│       ├── 04-discord-collect-topic-propose-dates.md
│       ├── 05-discord-date-selection-confirm.md
│       ├── 06-discord-view-schedule.md
│       ├── 07-error-handling-refinement.md
│       ├── 08-testing-setup-initial-tests.md
│       └── 09-include-topic-in-schedule-view.md
├── index.js
├── lib
│   ├── auto-catch.js
│   ├── discord
│   │   ├── commands
│   │   │   ├── check.js
│   │   │   └── llm.js
│   │   ├── deploy-commands.js
│   │   └── index.js
│   ├── llm
│   │   └── index.js
│   ├── mongo
│   │   ├── index.js
│   │   ├── mock-mongo.js
│   │   └── mongo.js
│   └── schedulingLogic.js
├── middleware
│   ├── auth-test.js
│   ├── auth.js
│   └── index.js
├── models
│   └── scheduledSpeaker.js
├── package-lock.json
├── package.json
├── server.js
└── test
    ├── api
    │   └── health.test.js
    ├── auth.test.js
    ├── auto-catch.test.js
    ├── helpers
    │   ├── cleanup.js
    │   └── mock-auth.js
    ├── index.js
    ├── mongo.test.js
    └── schedulingLogic.test.js

16 directories, 43 files


~/play/test/ai-in-action-bot main*

```

---

Okay, structure viewed and `PROJECT.md` checked (it just points to the README).

Now, I'll re-read the tutorial and then the target file `lib/discord/index.js` before applying the edit.

---

Read file: lib/discord/index.js

---

Got it. Now, applying the change from the tutorial to `lib/discord/index.js`.

---

```diff
              } else {
                const scheduleLines = upcomingSpeakers.map(speaker => {
-                 const formattedDate = speaker.scheduledDate.toLocaleDateString('en-US', { 
-                   weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
+                 const formattedDate = speaker.scheduledDate.toLocaleDateString('en-US', {
+                   weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                  });
                  const userDisplay = speaker.discordUsername;
-                 return `- ${formattedDate}: @${userDisplay}`;
+                 return `- ${formattedDate}: @${userDisplay} - "${speaker.topic}"`;
                });
  
```

---

Alright Big D, the code in `lib/discord/index.js` has been updated according to the tutorial to include the topic in the schedule view message.

I've checked `PROJECT.md` again, and it still doesn't require updates.

The task is complete.

---



---



---

