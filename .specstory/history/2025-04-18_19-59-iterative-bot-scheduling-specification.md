<!-- Generated by SpecStory -->

# Iterative Bot Scheduling Specification (2025-04-18 12:59:27)

_**User**_

Ask me one question at a time so we can develop a thorough, step-by-step spec for this idea. Each question should build on my previous answers, and our end goal is to have a detailed specification I can hand off to a developer. Let’s do this iteratively and dig into every relevant detail. Remember, only one question at a time.

Here’s the idea:

Could we have a bot schedule speakers for a weekly stream. currently we use a spreadsheet. users should be able to sign up, see the schedule

---

_**Assistant**_



---

Okay, Big D. Let's start digging into this scheduling bot idea.

How should users sign up to be a speaker? Should they use a specific command, react to a message, or something else?

---

_**User**_

'@' reference and say in natural language

---

_**Assistant**_



---

Okay, Big D. So users will mention the bot and say something like "@BotName I'd like to speak on stream sometime" to sign up.

Once a user has signed up, what information should the bot collect from them? For example, should it ask for their topic, preferred dates, or anything else?

---

_**User**_

username, topic, and preferred dates

---

_**Assistant**_



---

Okay, Big D. The bot needs to collect their username, topic, and preferred dates.

How should the bot ask for this information after a user signs up by mentioning it? Should it reply in the channel, send the user a direct message (DM), or use a pop-up form (modal)?

---

_**User**_

create thread and reply in there

---

_**Assistant**_



---

Got it, Big D. The bot will create a new thread from the user's sign-up message and ask for their username, topic, and preferred dates within that thread.

How should the bot handle the "preferred dates"? Should it ask for specific dates, a range of dates, or general availability (like "weekdays after 5 PM")?

---

_**User**_

bot should give a few options e.g. next 3 available fridays and see if they accept

---

_**Assistant**_



---

Okay, Big D. The bot will check its internal schedule, find the next three available Fridays, and present those dates as options in the thread.

How should the user indicate which of the proposed Fridays works for them? Should they reply with the date text, click a button associated with the date, or use a reaction emoji?

---

_**User**_

natural language. the user can reply naturally and the bot will know which of the list they are referring to (or that they want more options)

---

_**Assistant**_



---

Okay, Big D. The bot will use natural language understanding to figure out the user's choice from their reply in the thread.

What should happen if the bot isn't sure which date the user picked from the options, or if the user asks for a date that wasn't offered (e.g., "None of those work, can I do the 25th instead?")? Should it ask for clarification, suggest different dates again, or perhaps loop in someone with scheduling permissions?

---

_**User**_

just asking for clarification is good

---

_**Assistant**_



---

Got it, Big D. If the bot is unsure about the user's date selection from their natural language reply, it will simply ask for clarification within the thread.

Once the user has successfully confirmed one of the proposed dates, what should the bot do next? For example, should it confirm the booking in the thread, update an internal schedule, and maybe announce it somewhere?

---

_**User**_

confirm in thread and save to database (mongo)

---

_**Assistant**_



---

Okay, Big D. After the user confirms a date, the bot will reply in the thread confirming the booking and then save the speaker's username, topic, and the confirmed date to a MongoDB database.

Now, let's move on to how users can see the schedule. How should a user ask to view the upcoming speaker schedule?

---

_**User**_

natural language mention the bot the bot can just respond with the schedule

---

_**Assistant**_



---

Okay, Big D. Users can mention the bot and ask in natural language (e.g., "@BotName show me the schedule") to see the upcoming speakers.

How should the bot display the schedule when asked? Should it list the next few speakers, show the schedule for a specific month, or perhaps post a link to a persistent view?

---

_**User**_

just list the next few speakers and dates

---

_**Assistant**_



---

Okay, Big D. When asked, the bot will reply with a list of the next few scheduled speakers and their corresponding dates.

How many speakers should it list by default when someone asks to see the schedule? For example, the next 3, 5, or perhaps all currently scheduled speakers?

---

_**User**_

5 if there are that many probably won't be

Now that we’ve wrapped up the brainstorming process, can you compile our findings into a comprehensive, developer-ready specification? Include all relevant requirements, architecture choices, data handling details, error handling strategies, and a testing plan so a developer can immediately begin implementation.

---

_**Assistant**_



---

Okay, Big D. Based on our conversation, here is a comprehensive specification for the Stream Speaker Scheduling Bot.

---

## Stream Speaker Scheduling Bot Specification

**1. Introduction & Goal**

The goal of this Discord bot is to automate the process of scheduling speakers for a recurring weekly stream. It replaces the current spreadsheet-based manual system, allowing users to sign up, provide their details, select a date, and view the upcoming schedule directly within Discord.

**2. Core Features**

*   **Speaker Sign-up:** Users can initiate the sign-up process using natural language.
*   **Information Collection:** The bot gathers the speaker's topic and preferred dates.
*   **Automated Scheduling:** The bot proposes available dates and confirms the booking with the user.
*   **Schedule Viewing:** Users can ask the bot to display the upcoming schedule.

**3. Detailed Workflows**

*   **A. Speaker Sign-up & Scheduling Flow:**
    1.  **Trigger:** A user mentions the bot in a channel using natural language that indicates they want to sign up as a speaker (e.g., `@BotName I'd like to speak on the stream`).
    2.  **Bot Action (Thread Creation):** The bot creates a private thread starting from the user's sign-up message.
    3.  **Bot Action (Information Request):** The bot replies within the newly created thread, welcoming the user and asking for their presentation `topic`.
    4.  **User Action (Topic):** The user replies in the thread with their topic.
    5.  **Bot Action (Date Proposal):**
        *   The bot queries the `scheduledSpeakers` collection in the MongoDB database to find dates that already have speakers scheduled.
        *   It identifies the next 3 upcoming Fridays that are *not* booked.
        *   The bot replies in the thread, presenting these 3 available Friday dates as options.
    6.  **User Action (Date Selection):** The user replies in the thread using natural language to indicate their preferred date from the options provided (e.g., "The first one works", "How about the 15th?", "None of those work, any other options?").
    7.  **Bot Action (Date Parsing & Clarification):**
        *   The bot uses Natural Language Processing (NLP) to interpret the user's response and identify which date (if any) they selected from the proposed options.
        *   If the bot cannot confidently determine the user's choice or if the user asks for unavailable dates/more options, it replies in the thread asking for clarification (e.g., "Sorry, I didn't quite catch that. Which of these dates works best: [Date1], [Date2], [Date3]?"). This loop repeats until a valid proposed date is clearly selected.
    8.  **Bot Action (Confirmation & Persistence):**
        *   Once the user clearly confirms one of the available, proposed dates, the bot replies in the thread confirming the booking: "Great! You're confirmed to speak on [Topic] on [Confirmed Date].".
        *   The bot saves the booking details to the MongoDB database. (See Data Model below).

*   **B. Schedule Viewing Flow:**
    1.  **Trigger:** A user mentions the bot in a channel using natural language asking to see the schedule (e.g., `@BotName show me the upcoming speaker schedule`).
    2.  **Bot Action (Database Query):** The bot queries the `scheduledSpeakers` collection in MongoDB, fetching upcoming scheduled speakers sorted by date.
    3.  **Bot Action (Display Schedule):** The bot replies in the channel (or potentially the thread if the request originated there) with a message listing the next 5 scheduled speakers (or fewer, if less than 5 are booked). The format should clearly show the date and the speaker's username for each entry (e.g., "Upcoming Speakers:\n- [Date1]: @[Username1]\n- [Date2]: @[Username2]\n...").

**4. Architecture & Technology**

*   **Platform:** Discord Bot
*   **Language/Framework:** Node.js
*   **Database:** MongoDB
*   **Discord Interaction:** `discord.js` library (based on existing `llm.js` command)
*   **Natural Language Processing (NLP):** A suitable Node.js library (e.g., `compromise`, `natural`) or potentially leverage the existing LLM infrastructure (`lib/llm.js`) if feasible for intent recognition (sign-up, view schedule) and date selection parsing. Initial implementation might use simpler keyword/regex matching.

**5. Data Model (MongoDB)**

*   **Collection:** `scheduledSpeakers`
*   **Document Schema:**
    ```json
    {
      "discordUserId": "string", // User's Discord ID
      "discordUsername": "string", // User's Discord username at time of booking
      "topic": "string", // Speaker's topic
      "scheduledDate": "Date", // ISODate format (YYYY-MM-DD) representing the Friday they are scheduled. Ensure only the date part is relevant for uniqueness.
      "bookingTimestamp": "Date", // ISODate format (Timestamp when booking was confirmed)
      "threadId": "string" // Optional: Discord ID of the thread used for scheduling
    }
    ```
*   **Index:** Create a unique index on `scheduledDate` to prevent double-booking the same Friday.

**6. Error Handling**

*   **Ambiguous NLP Input:** If the bot cannot understand user input after asking for clarification, it should respond with a message like, "Sorry, I'm having trouble understanding. Could you please rephrase, or perhaps ask an admin for help?".
*   **Database Errors:** Catch potential errors during database operations (connection, reads, writes). Log the error internally. Respond to the user with a generic failure message: "Sorry, I encountered a database issue while processing your request. Please try again later."
*   **Scheduling Conflict (Race Condition):** Rely on the unique index on `scheduledDate` in MongoDB. If an insert fails due to the date already existing (caught during the confirmation step), inform the user in the thread that the date just became unavailable and re-prompt with newly fetched available dates.
*   **Discord API Errors:** Implement standard error handling for Discord API interactions (e.g., logging, potential retries for rate limits if applicable). Inform the user if a Discord-related error prevents action completion.
*   **No Available Dates:** If the bot cannot find 3 available Fridays within a reasonable future timeframe (e.g., next 3-6 months), it should inform the user that no slots seem available soon and perhaps suggest contacting an admin.

**7. Testing Plan (Node.js Environment)**

*   **Unit Tests (`tape` or `ava`):**
    *   Mock MongoDB interactions (`mongodb-memory-server` or similar).
    *   Test the logic for finding the next 3 available Fridays based on mock data.
    *   Test the NLP/parsing logic for sign-up intent detection with various inputs.
    *   Test the NLP/parsing logic for date selection with various inputs (confirming, rejecting, asking for clarification).
    *   Test the database schema validation and insertion logic.
    *   Test the schedule formatting logic.
*   **Integration Tests:**
    *   Use a test MongoDB instance.
    *   Mock the `discord.js` client interactions.
    *   Test the end-to-end flow for signing up and getting scheduled, verifying thread creation, messages, and database state changes.
    *   Test the end-to-end flow for viewing the schedule, verifying database queries and response formatting.
*   **End-to-End Testing (Manual):**
    *   Deploy the bot to a dedicated test Discord server/channel.
    *   Interact with the bot as a user:
        *   Sign up using different natural language phrases.
        *   Provide a topic.
        *   Respond to date prompts: select valid dates, respond ambiguously, ask for other dates.
        *   Verify bot's clarification messages and final confirmation.
        *   Check the MongoDB database manually to confirm data persistence.
        *   Ask to view the schedule using different phrases.
        *   Verify the schedule output is correct and matches the database state.
        *   Attempt to sign up for a date that is already taken.
*   **Test Execution:** Ensure all automated tests (`npm test`) run cleanly and exit without hanging processes (e.g., open database connections).

---

This specification should provide a clear roadmap for a developer, Big D. Let me know if you want to refine any part of this!

---



---

